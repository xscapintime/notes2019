

> SO HOT!
![](https://upload-images.jianshu.io/upload_images/14383117-b8b813e72fc531ab.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

[åŸé¢˜ç›®åœ¨è¿™é‡Œ](http://www.bio-info-trainee.com/3409.html)


### 1. å®‰è£…ä¸€äº›RåŒ…

### 1.1 å®‰è£…

#### 1.1.1 `ALL`

```R
> if (!requireNamespace("BiocManager", quietly = TRUE))
+     install.packages("BiocManager")
> 
> BiocManager::install("ALL")
```

#### 1.1.2 `pasilla`

```R
> if (!requireNamespace("BiocManager", quietly = TRUE))
+    install.packages("BiocManager")
>
> BiocManager::install("pasilla")
```

#### 1.1.3 `airway`

```R
> if (!requireNamespace("BiocManager", quietly = TRUE))
+    install.packages("BiocManager")
>
> BiocManager::install("airway")
```

#### 1.1.4 `limma`

```R
> if (!requireNamespace("BiocManager", quietly = TRUE))
+     install.packages("BiocManager")
> 
> BiocManager::install("limma")
```

#### 1.1.5 `DESeq2`

```R
> if (!requireNamespace("BiocManager", quietly = TRUE))
+    install.packages("BiocManager")

> BiocManager::install("DESeq2")
```

#### 1.1.6 `clusterProfiler`

```R
> if (!requireNamespace("BiocManager", quietly = TRUE))
+     install.packages("BiocManager")
> 
> BiocManager::install("clusterProfiler")
```

#### 1.1.7 `reshape2`

```R
> install.packages('reshape2')
```

#### 1.1.8 `ggplot2`

```R
> install.packages('ggplot2')
```

### 1.2 è¿è¡Œ

ç”¨ `library()`æ£€æŸ¥å·²å®‰è£…çš„åŒ…æ˜¯å¦èƒ½å¤Ÿè¿è¡Œ

e.g.

```R
> library(CLL)
# è½½å…¥éœ€è¦çš„ç¨‹è¾‘åŒ…ï¼šaffy
# è½½å…¥éœ€è¦çš„ç¨‹è¾‘åŒ…ï¼šBiocGenerics
# è½½å…¥éœ€è¦çš„ç¨‹è¾‘åŒ…ï¼šparallel
# 
# è½½å…¥ç¨‹è¾‘åŒ…ï¼šâ€˜BiocGenericsâ€™
# 
# The following objects are masked from â€˜package:parallelâ€™:
#   
#   clusterApply, clusterApplyLB, clusterCall, clusterEvalQ,
# clusterExport, clusterMap, parApply, parCapply, parLapply,
# parLapplyLB, parRapply, parSapply, parSapplyLB
# 
# The following objects are masked from â€˜package:statsâ€™:
#   
#   IQR, mad, sd, var, xtabs
# 
# The following objects are masked from â€˜package:baseâ€™:
#   
#   anyDuplicated, append, as.data.frame, basename, cbind, colnames,
# dirname, do.call, duplicated, eval, evalq, Filter, Find, get,
# grep, grepl, intersect, is.unsorted, lapply, Map, mapply, match,
# mget, order, paste, pmax, pmax.int, pmin, pmin.int, Position,
# rank, rbind, Reduce, rownames, sapply, setdiff, sort, table,
# tapply, union, unique, unsplit, which, which.max, which.min
# 
# è½½å…¥éœ€è¦çš„ç¨‹è¾‘åŒ…ï¼šBiobase
# Welcome to Bioconductor
# 
# Vignettes contain introductory material; view with
# 'browseVignettes()'. To cite Bioconductor, see
# 'citation("Biobase")', and for packages 'citation("pkgname")'.
```

è‹¥è¯•å›¾è¿è¡Œä¸€ä¸ªæ²¡æœ‰å®‰è£…çš„åŒ…ï¼š

```R
> available.packages()
#                              Package                         Version         
# A3                            "A3"                            "1.0.0" 
> library(A3)
# Error in library(A3) : ä¸å­˜åœ¨å«â€˜A3â€™è¿™ä¸ªåå­—çš„ç¨‹è¾‘åŒ…
```



### 2. ï¦ºè§£ExpressionSetå¯¹è±¡

*æ¯”å¦‚CLLåŒ…ï§©é¢å°±æœ‰data(sCLLex) ï¼Œæ‰¾åˆ°å®ƒåŒ…å«çš„å…ƒç´ ï¼Œæå–å…¶è¡¨è¾¾çŸ©é˜µ(ä½¿ç”¨exprså‡½æ•°)ï¼ŒæŸ¥çœ‹å…¶å¤§å°ã€‚*

æå–è¡¨è¾¾çŸ©é˜µï¼š

 ```R
> library('CLL')
> data("sCLLex")
> exprSet <- exprs(sCLLex)
 ```

æŸ¥çœ‹å¤§å°ï¼š

```R
> dim(exprSet)
# [1] 12625    22
> str(exprSet)
#  num [1:12625, 1:22] 5.74 2.29 3.31 1.09 7.54 ...
 - attr(*, "dimnames")=List of 2
  ..$ : chr [1:12625] "1000_at" "1001_at" "1002_f_at" "1003_s_at" ...
  ..$ : chr [1:22] "CLL11.CEL" "CLL12.CEL" "CLL13.CEL" "CLL14.CEL" ...
```



### 3. ï¦ºè§£ str,head,helpå‡½æ•°ï¼Œä½œç”¨äº ç¬¬äºŒæ­¥æå–åˆ°çš„è¡¨è¾¾çŸ©é˜µ

### 3.1 `str()`

``` r
> str(exprSet)
#  num [1:12625, 1:22] 5.74 2.29 3.31 1.09 7.54 ...
 - attr(*, "dimnames")=List of 2
  ..$ : chr [1:12625] "1000_at" "1001_at" "1002_f_at" "1003_s_at" ...
  ..$ : chr [1:22] "CLL11.CEL" "CLL12.CEL" "CLL13.CEL" "CLL14.CEL" ...
```

> Compactly display the internal structure of an R object, a diagnostic function and an alternative to summary (and to some extent, dput). Ideally, only one line for each â€˜basicâ€™ structure is displayed. It is especially well suited to compactly display the (abbreviated) contents of (possibly nested) lists. The idea is to give reasonable output for any R object. It calls args for (non-primitive) function objects.

>  ç”¨äºæŸ¥çœ‹çŸ©é˜µçš„å¤§å°ï¼ˆåˆ—æ•°ã€è¡Œæ•°ï¼‰ï¼ŒæŸ¥çœ‹åˆ—åã€è¡Œåçš„ç¤ºä¾‹ã€‚

### 3.2 `head()`

```R
> head(exprSet)
#          CLL11.CEL CLL12.CEL CLL13.CEL CLL14.CEL CLL15.CEL CLL16.CEL
# 1000_at    5.743132  6.219412  5.523328  5.340477  5.229904  4.920686
# 1001_at    2.285143  2.291229  2.287986  2.295313  2.662170  2.278040
# 1002_f_at  3.309294  3.318466  3.354423  3.327130  3.365113  3.568353
# 1003_s_at  1.085264  1.117288  1.084010  1.103217  1.074243  1.073097
# 1004_at    7.544884  7.671801  7.474025  7.152482  6.902932  7.368660
# 1005_at    5.083793  7.610593  7.631311  6.518594  5.059087  4.855161
# ...
```

> Returns the first or last parts of a vector, matrix, table, data frame or function. Since head() and tail() are generic functions, they may also have been extended to other classes.

>  ç”¨äºæŸ¥çœ‹å¯¹è±¡çš„å‰å‡ è¡Œï¼Œé»˜è®¤ä¸ºå‰6è¡Œï¼Œå¯é€šè¿‡ `n = xL` è°ƒæ•´ã€‚



### 3.3 `help()`

```R
> help("exprs")
```

![R Documentation](https://upload-images.jianshu.io/upload_images/14383117-bcd61082d2fbffc3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

> help is the primary interface to the help systems.

ç”¨äºè°ƒå‡º R Documentation å¯¹æŸä¸ªå‡½æ•°çš„è¯´æ˜é¡µé¢ï¼Œ`?fuction` æ˜¯ `help()` çš„ç®€ç•¥å†™æ³•



### 4. å®‰è£…å¹¶ï¦ºè§£ hgu95av2.db åŒ…

*çœ‹çœ‹ ls(â€œpackage:hgu95av2.dbâ€) åæ˜¾ç¤ºçš„å“ªäº›å˜ï¥¾ï¼Ÿ*

å®‰è£…ï¼š

```R
> if (!requireNamespace("BiocManager", quietly = TRUE))
+ install.packages("BiocManager")
>  
> BiocManager::install("hgu95av2.db")
```

```R
> library(hgu95av2.db)
> ls("package:hgu95av2.db")
# [1] "hgu95av2"              "hgu95av2.db"           "hgu95av2_dbconn"     
# [4] "hgu95av2_dbfile"       "hgu95av2_dbInfo"       "hgu95av2_dbschema"   
# [7] "hgu95av2ACCNUM"        "hgu95av2ALIAS2PROBE"   "hgu95av2CHR"         
# [10] "hgu95av2CHRLENGTHS"    "hgu95av2CHRLOC"        "hgu95av2CHRLOCEND" 
# [13] "hgu95av2ENSEMBL"       "hgu95av2ENSEMBL2PROBE" "hgu95av2ENTREZID"   
# [16] "hgu95av2ENZYME"        "hgu95av2ENZYME2PROBE"  "hgu95av2GENENAME"   
# [19] "hgu95av2GO"            "hgu95av2GO2ALLPROBES"  "hgu95av2GO2PROBE"   
# [22] "hgu95av2MAP"           "hgu95av2MAPCOUNTS"     "hgu95av2OMIM"       
# [25] "hgu95av2ORGANISM"      "hgu95av2ORGPKG"        "hgu95av2PATH"       
# [28] "hgu95av2PATH2PROBE"    "hgu95av2PFAM"          "hgu95av2PMID"       
# [31] "hgu95av2PMID2PROBE"    "hgu95av2PROSITE"       "hgu95av2REFSEQ"     
# [34] "hgu95av2SYMBOL"        "hgu95av2UNIGENE"       "hgu95av2UNIPROT"   
```

```R
> as.list(hgu95av2GO[1]
# $`1000_at`$`GO:0097110`
# $`1000_at`$`GO:0097110`$GOID
# [1] "GO:0097110"

# $`1000_at`$`GO:0097110`$Evidence
# [1] "IEA"

# $`1000_at`$`GO:0097110`$Ontology
# [1] "MF"
```

> `1000_at`ä¸ºæ¢é’ˆï¼Œåˆ†åˆ«æ˜¾ç¤ºGOID, Evidenceï¼ˆåŸºå› æ³¨é‡Šè¯æ®ä»£ç ï¼‰, Ontologyï¼ˆåŸºå› æœ¬ä½“è®ºä¸­çš„ä¸‰ä¸ªåˆ†ç±»ï¼Œ*BP = Biological Process; CC = Cellular Component; MF = Molecular Function*ï¼‰.

```R
> as.list(hgu95av2UNIGENE[1])
# $`1000_at`
# [1] "Hs.861"
```

> "Hs.861"ä¸ºNCBI UniGeneæ•°æ®åº“çš„ID.

æå–å…¶ä¸­çš„æ•°æ®ï¼š

```R
> get(featureNames(sCLLex)[1],hgu95av2GO)[1]
# $`GO:0000165`
# $`GO:0000165`$GOID
# [1] "GO:0000165"

# $`GO:0000165`$Evidence
# [1] "NAS"

# $`GO:0000165`$Ontology
# [1] "BP"
```



### 5. ï§¤è§£ head(toTable(hgu95av2SYMBOL)) çš„ç”¨æ³•

*æ‰¾åˆ°TP53åŸºå› å¯¹åº”çš„æ¢é’ˆID*

```R
> head(toTable(hgu95av2SYMBOL))
#    probe_id  symbol
# 1   1000_at   MAPK3
# 2   1001_at    TIE1
# 3 1002_f_at CYP2C19
# 4 1003_s_at   CXCR5
# 5   1004_at   CXCR5
# 6   1005_at   DUSP1
```

æ‰¾åˆ°TP53åŸºå› å¯¹åº”çš„æ¢é’ˆIDï¼š

```R
> ids <- toTable(hgu95av2SYMBOL)
> grep("TP53",ids$symbol)
# [1]   732   884   966   997  1420  2675  3322  4120  4304  5475  5526 10084
> ids[grep("TP53",ids$symbol),]
#         probe_id  symbol
# 732      1711_at TP53BP1
# 884      1860_at TP53BP2
# 966      1939_at    TP53
# 997    1974_s_at    TP53
# 1420    31618_at    TP53
# 2675    33025_at TP53TG5
# 3322    33749_at TP53TG1
# 4120    34629_at TP53I11
# 4304    34822_at TP53BP2
# 5475    36079_at  TP53I3
# 5526    36136_at TP53I11
# 10084 40986_s_at TP53BP1
```



### 6. ï§¤è§£æ¢é’ˆä¸åŸºå› çš„å¯¹åº”å…³ç³»

*æ€»å…±å¤šå°‘ä¸ªåŸºå› ï¼ŒåŸºå› æœ€å¤šå¯¹åº”å¤šå°‘ä¸ªæ¢é’ˆï¼Œæ˜¯å“ªäº›åŸºå› ï¼Œæ˜¯ï¥§æ˜¯å› ä¸ºè¿™äº›åŸºå› å¾ˆé•¿ï¼Œæ‰€ä»¥åœ¨å…¶ä¸Šé¢è®¾è®¡å¤šä¸ªæ¢é’ˆå‘¢ï¼Ÿ*

```R
> summary(hgu95av2SYMBOL)
# SYMBOL map for chip hgu95av2 (object of class "ProbeAnnDbBimap")
# |
# | Lkeyname: probe_id (Ltablename: probes)
# |    Lkeys: "1000_at", "1001_at", ... (total=12625/mapped=11460)
# |
# | Rkeyname: symbol (Rtablename: gene_info)
# |    Rkeys: "A1BG", "A2M", ... (total=61468/mapped=8585)
# |
# | direction: L --> R
```

> å…±æœ‰61468ä¸ªåŸºå› ï¼Œå¯¹åº”ä¸Š8585ä¸ªã€‚

```R
> table(ids$symbol) %>% sort() %>% tail()

# YME1L1  GAPDH INPP4A    MYB PTGER3  STAT1 
#     7      8      8      8      8      8 
```

> åˆ—å‡º ids çš„ 'symbol' åˆ—åŠæ¯ä¸ªå…ƒç´ å‡ºç°çš„ä¸ªæ•°ï¼Œæ’åºï¼Œæ˜¾ç¤ºæœ€å6ä¸ªï¼›
>
> å¾—åˆ°å¯¹åº”æœ€å¤šæ¢é’ˆçš„åŸºå› ã€‚

> åŸºå› é•¿åº¦ä¸è®¾è®¡åœ¨ä¸Šé¢çš„æ¢é’ˆæ•°é‡æ— å…³ã€‚

### 7. ç¬¬äºŒæ­¥æå–åˆ°çš„è¡¨è¾¾çŸ©é˜µï¼Œæ‰¾åˆ°é‚£äº›ï¥§åœ¨ hgu95av2.db åŒ…æ”¶å½•çš„å¯¹åº”ç€SYMBOLçš„æ¢é’ˆ

```R
> mapped_probes <- mappedkeys(hgu95av2SYMBOL)
> exprSetpb <- row.names(exprSet)
> length(grep("FALSE",(exprSetpb %in% mapped_probes)))
# [1] 1165
> grep("FALSE",(exprSetpb %in% mapped_probes))
# [1]     8    52    98    99   100   109   115   117   128   135   157   168
# [13]   169   171   174   195   197   199   203   219   225   282   283   292
# ...
> head(exprSetpb[index])
# [1] "1007_s_at" "1047_s_at" "1089_i_at" "108_g_at"  "1090_f_at" "1099_s_at"
```

> ä¸ç¡®å®šå¯¹ä¸å¯¹....



### 8. è¿‡æ»¤è¡¨è¾¾çŸ©é˜µ

*åˆ é™¤é‚£1165ä¸ªæ²¡æœ‰å¯¹åº”åŸºå› åå­—çš„æ¢é’ˆã€‚*

```R
> e = exprSet[rownames(exprSet) %in% mapped_probes,]
> str(exprSet)
# num [1:12625, 1:22] 5.74 2.29 3.31 1.09 7.54 ...
# - attr(*, "dimnames")=List of 2
#  ..$ : chr [1:12625] "1000_at" "1001_at" "1002_f_at" "1003_s_at" ...
#  ..$ : chr [1:22] "CLL11.CEL" "CLL12.CEL" "CLL13.CEL" "CLL14.CEL" ...
> str(e)
# num [1:11460, 1:22] 5.74 2.29 3.31 1.09 7.54 ...
# - attr(*, "dimnames")=List of 2
#  ..$ : chr [1:11460] "1000_at" "1001_at" "1002_f_at" "1003_s_at" ...
#  ..$ : chr [1:22] "CLL11.CEL" "CLL12.CEL" "CLL13.CEL" "CLL14.CEL" ...
```



### 9. æ•´åˆè¡¨è¾¾çŸ©é˜µ

*å¤šä¸ªæ¢é’ˆå¯¹åº”ä¸€ä¸ªåŸºå› çš„æƒ…å†µä¸‹ï¼Œåªä¿ï§åœ¨æ‰€æœ‰æ ·æœ¬ï§©é¢å¹³å‡è¡¨è¾¾ï¥¾æœ€å¤§çš„é‚£ä¸ªæ¢é’ˆã€‚*

```R
> maxid = by(e,ids$symbol,function(x) rownames(x)[which.max(rowMeans(x))])
# æŒ‰ç…§ ids$symbol å°† e åˆ†ç»„ï¼Œå–è¡Œå¹³å‡å€¼æœ€å¤§çš„è¡Œ çš„ è¡Œå
# ä½†ï¼Œä¸ºä»€ä¹ˆè¦ç”¨ symbol åˆ†ç»„å‘¢ ğŸ˜‚
> uniid = as.character(maxid)
> uni_e = e[rownames(e) %in% uniid,]
```

```R
> maxid = by(e,ids$probe_id,function(x) rownames(x)[which.max(rowMeans(x))])
> uniid = as.character(maxid)
> uni_e = e[rownames(e) %in% uniid,]
> str(uni_e)
# num [1:11460, 1:22] 5.74 2.29 3.31 1.09 7.54 ...
# - attr(*, "dimnames")=List of 2
#  ..$ : chr [1:11460] "1000_at" "1001_at" "1002_f_at" "1003_s_at" ...
#  ..$ : chr [1:22] "CLL11.CEL" "CLL12.CEL" "CLL13.CEL" "CLL14.CEL" ...
# emmmmm ç»“å±€æ˜¯ä¸€æ ·çš„ï¼Œokæˆ‘æ‡‚äº†
```



### 10. æŠŠè¿‡æ»¤åçš„è¡¨è¾¾çŸ©é˜µï¤æ”¹ï¨ˆåä¸ºåŸºå› çš„symbol

*å› ä¸ºè¿™ä¸ªæ—¶å€™æ¢é’ˆå’ŒåŸºå› æ˜¯ä¸€å¯¹ä¸€å…³ç³»ï¦ºã€‚*

```R
> rownames(uni_e) = ids[match(rownames(uni_e),ids$probe_id),2]
# å°†idsçš„ç¬¬2åˆ—(symbol)å¯¹åº”åˆ° uni_e çš„è¡Œå
> library(reshape2)
> m_e = melt(uni_e)
> colnames(m_e) = c('symbol','sample','value')
```

![reshape2_melt()](https://upload-images.jianshu.io/upload_images/14383117-94943f13a824f190.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

åˆ†ç»„ï¼š

```R
> pd = pData(sCLLex)
> Disease = pd[,2]
> table(Disease)
# Disease
# progres.   stable 
#      14        8 
> m_e$group = rep(Disease,each=nrow(uni_e))
```



### 11. å¯¹ç¬¬10æ­¥å¾—åˆ°çš„è¡¨è¾¾çŸ©é˜µè¿›ï¨ˆæ¢ç´¢

*å…ˆç”»ç¬¬ä¸€ä¸ªæ ·æœ¬çš„æ‰€æœ‰åŸºå› çš„è¡¨è¾¾ï¥¾çš„boxplot,hist,densityï¼Œç„¶åç”»æ‰€æœ‰æ ·æœ¬çš„è¿™äº›å›¾*

```R
> suppressPackageStartupMessages(library(ggplot2))
> ggplot(m_e,aes(x=sample,y=value,fill=group))+geom_boxplot()
```

![ggplot_box](https://upload-images.jianshu.io/upload_images/14383117-24fdb0cfcabae448.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

```r
> ggplot(m_e,aes(value,fill=group)) + geom_histogram(bins = 200)+facet_wrap(~sample, nrow = 4)
```

![ggplot_facetwrap](https://upload-images.jianshu.io/upload_images/14383117-19c92c5b5f04fa4c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

```R
> ggplot(m_e,aes(value,col=group)) + geom_density()
```

[å›¾ç‰‡ä¸Šä¼ å¤±è´¥...(image-e00840-1559916805026)]

### 12. ï§¤è§£ç»Ÿè®¡å­¦æŒ‡æ ‡mean,median,max,min,sd,var,mad

*å¹¶è®¡ç®—å‡ºæ¯ä¸ªåŸºå› åœ¨æ‰€æœ‰æ ·æœ¬çš„è¿™äº›ç»Ÿè®¡å­¦æŒ‡æ ‡ï¼Œæœ€åæŒ‰ç…§madå€¼æ’åºï¼Œå–top 50 madå€¼çš„åŸºå› ï¼Œå¾—åˆ°ï¦œè¡¨ã€‚(æ³¨æ„ï¼šè¿™ä¸ªé¢˜ç›®å‡ºçš„å¹¶ï¥§åˆè§„ï¼Œè¯·ä»”ç»†çœ‹ã€‚)*

### 12.1 mean

ç®—æœ¯å¹³å‡å€¼

```R
> meanlist=apply(uni_e, 1, mean)
> head(meanlist)
#  UTF1        EVX1      ADGRB1        SYN1      CHRNB4        ARR3 
# -0.14880683 -0.13705268  0.05817044  0.07589677  0.08317654  0.20826165 
```

### 12.2 median

ä¸­ä½æ•°

```R
> mdlist=apply(uni_e, 1, median)
> head(mdlist)
#    MAPK3     TIE1  CYP2C19    CXCR5    DUSP1    MMP10 
# 5.368993 2.333562 3.378740 7.402258 5.902370 3.320628
```

### 12.3 max

æœ€å¤§å€¼

```R
> maxlist=apply(uni_e, 1, max)
> head(maxlist)
#    MAPK3     TIE1  CYP2C19    CXCR5    DUSP1    MMP10 
# 6.251678 2.662170 3.798335 8.802729 9.919125 3.574332 
```

### 12.4 min

æœ€å°å€¼

```R
> minlist=apply(uni_e, 1, min)
> head(minlist)
#    MAPK3     TIE1  CYP2C19    CXCR5    DUSP1    MMP10 
# 4.826131 2.222276 3.247276 6.456285 4.097580 3.213493 
```

### 12.5 sd

æ ‡å‡†å·®

```R
> sdlist=apply(uni_e, 1, sd)
> head(sdlist)
#      MAPK3       TIE1    CYP2C19      CXCR5      DUSP1      MMP10 
# 0.36652641 0.09046121 0.12801488 0.58908623 1.73368583 0.10074804 
```

### 12.6 var

æ–¹å·®

```R
> varlist=apply(uni_e, 1, var)
> head(varlist)
#      MAPK3       TIE1    CYP2C19      CXCR5      DUSP1      MMP10 
# 0.13434161 0.00818323 0.01638781 0.34702258 3.00566656 0.01015017 
```

### 12.7 mad

ç»å¯¹ä¸­ä½å·®Median Absolute Deviation

```R
> madlist=apply(uni_e, 1, mad)
> head(madlist)
#      MAPK3       TIE1    CYP2C19      CXCR5      DUSP1      MMP10 
# 0.22779776 0.06516670 0.08294023 0.38497146 1.43854685 0.09476130 
```

top 50 madå€¼çš„åŸºå› ï¼š

```R
> tail(sort(madlist),50)
#     PFN2   TNFSF9 ARHGAP44   P2RY14  THEMIS2      LPL    ANXA4    DUSP6 
# 1.481294 1.485155 1.488032 1.505107 1.507287 1.532212 1.533327 1.551320 
#    DUSP5     H1FX     FLNA   CLEC2B   TSPYL2   ZNF266   S100A9    NR4A2 
# 1.553782 1.557412 1.574436 1.578055 1.582430 1.587748 1.608285 1.612875 
#    TGFBI     ARF6    APBB2     VCAN    RBM38     CAPG   PLXNC1     RGS2 
# 1.643149 1.654548 1.674443 1.681098 1.703638 1.713747 1.718297 1.770151 
#   RNASE6    VAMP5     CYBB     GNLY     CCL3     OAS1    TRIB2  ZNF804A 
# 1.775430 1.791017 1.811973 1.814364 1.862311 1.883509 1.937294 1.986163 
#      IGH    PCDH9    VIPR1   COBLL1  GUSBP11   S100A8      HBB   LHFPL2 
# 2.090866 2.144223 2.171912 2.179666 2.204212 2.220970 2.267136 2.317045 
#     FCN1    ZAP70    IGLC1   LGALS1      FOS   SLAMF1     TCF7      DMD 
# 2.371590 2.579046 2.590895 2.600604 2.938078 2.944105 2.993352 3.071541 
#  IGF2BP3   FAM30A 
# 3.234011 3.982191 
```



### 13. æ ¹æ®ç¬¬12æ­¥éª¤å¾—åˆ°top 50 madå€¼çš„åŸºå› ï¦œè¡¨æ¥å–è¡¨è¾¾çŸ©é˜µçš„å­é›†

*å¹¶ä¸”çƒ­å›¾å¯è§†åŒ–å­è¡¨è¾¾çŸ©é˜µã€‚è¯•è¯•çœ‹å…¶å®ƒ5ç§çƒ­å›¾çš„åŒ…çš„ï¥§åŒæ•ˆæœã€‚*

å–å­é›†ï¼š

```R
> top50gene=tail(sort(madlist),50)
> top50gene=as.data.frame(top50gene)
> top50genelist=rownames(top50gene)
> top50matrix=uni_e[top50genelist,]
> ct=scale(top50matrix,center=T,scale=F)  ## ä¸­å¿ƒåŒ–
> nmlztop50matrix=scale(ct,center=T,scale=T) ## æ ‡å‡†åŒ–
```

```R
> pheatmap::pheatmap(nmlztop50matrix)
```



![pheatmap](https://upload-images.jianshu.io/upload_images/14383117-34e237728f1041ea.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

```R
> heatmap(nmlztop50matrix)
```

![heatmap](https://upload-images.jianshu.io/upload_images/14383117-b8057d54dee4953b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

```R
> ggplot(ml_nmtop50,aes(sample,symbol))+
+   geom_tile(aes(fill=value),colour = "white")+
+   scale_fill_gradient(low = "white",high = "steelblue")
```

![ggplot_heatmap](https://upload-images.jianshu.io/upload_images/14383117-47efac40c19e9dab.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

```R
> library(gplots)
> heatmap.2(nmlztop50matrix,key = T,symkey = FALSE,density.info="none",trace="none")
```

![gplots_heatmap.2](https://upload-images.jianshu.io/upload_images/14383117-dd201f82224754e4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

```R
> library(lattice)
> library(latticeExtra)
> x  <- t(as.matrix(scale(nmlztop50matrix)))
> dd.row <- as.dendrogram(hclust(dist(x)))
> row.ord <- order.dendrogram(dd.row)
> levelplot(t(nmlztop50matrix),aspect = "fill",xlab="sample",ylab="symbol",colorkey = list(space = "left"),legend=list(right=list(fun=dendrogramGrob,args=list(x=dd.row,rod=row.ord,side='right',size=5))))
> levelplot(t(nmlztop50matrix),aspect =
+             "fill",xlab="sample",ylab="symbol",colorkey =
+             list(space = "left"),legend=
+             list(right=list(fun=dendrogramGrob,args=
+                               list(x=dd.row,rod=row.ord,side='right',size=5))))
```

![lattice_levelplot](https://upload-images.jianshu.io/upload_images/14383117-d66cb644c8eaad9a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

> emmm PDFç¤ºä¾‹é‡Œçš„ä»£ç è·‘å‡ºæ¥top50matirxé‡Œæ˜¯å¾ˆå¤šåŸºå› çš„é‡å¤ï¼Œsoè¿™æ˜¯æˆ‘ç¢ç£¨å‡ºæ¥çš„ç»“æœ



### 14. å–ï¥§åŒç»Ÿè®¡å­¦æŒ‡æ ‡mean,median,max,mean,sd,var,madçš„å„top50åŸºå› ï¦œè¡¨

*ä½¿ç”¨UpSetRåŒ…æ¥çœ‹ä»–ä»¬ä¹‹é—´çš„overlapæƒ…å†µã€‚*

å„åˆ—è¡¨ï¼š

```R
> e_mean=tail(sort(meanlist),50)
> e_md=tail(sort(mdlist),50)
> e_max=tail(sort(maxlist),50)
> e_min=tail(sort(minlist),50)
> e_sd=tail(sort(sdlist),50)
> e_var=tail(sort(varlist),50)
> e_mad=tail(sort(madlist),50)
```

```R
> suppressPackageStartupMessages(library("UpSetR"))
> library(magrittr)
> e_all = data.frame(all,
+                    e_mean=ifelse(all %in% names(e_mean),1,0),
+                    e_md=ifelse(all %in% names(e_md),1,0),
+                    e_max=ifelse(all %in% names(e_max),1,0),
+                    e_min=ifelse(all %in% names(e_min),1,0),
+                    e_sd=ifelse(all %in% names(e_sd),1,0),
+                    e_var=ifelse(all %in% names(e_var),1,0),
+                    e_mad=ifelse(all %in% names(e_mad),1,0)
+ )
> upset(e_all,nsets = 7,sets.bar.color = "#BD1111")
```

![UpSetR_magrittr](https://upload-images.jianshu.io/upload_images/14383117-f4aee7ad4baf08c9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)



### 15. åœ¨ç¬¬äºŒæ­¥çš„åŸºç¡€ä¸Šé¢æå–CLLåŒ…ï§©é¢çš„data(sCLLex) æ•°æ®å¯¹è±¡çš„æ ·æœ¬çš„è¡¨å‹æ•°æ®ã€‚

```R
> pd=pData(sCLLex)
> grouplist=as.character(pd[,2])
> table(grouplist)
# grouplist
# progres.   stable 
#       14        8 
```



### 16. å¯¹æ‰€æœ‰æ ·æœ¬çš„è¡¨è¾¾çŸ©é˜µè¿›ï¨ˆèšç±»å¹¶ä¸”ç»˜å›¾

*ç„¶åæ·»åŠ æ ·æœ¬çš„ä¸´åºŠè¡¨å‹æ•°æ®ä¿¡æ¯(ï¤æ”¹æ ·æœ¬å)*

```R
> clust = t(exprSet)
> rownames(clust) = colnames(exprSet)
> View(clust)
> View(exprSet)
> clust_dist = dist(clust,method = "euclidean")
> hc = hclust(clust_dist,"ward.D")
> suppressPackageStartupMessages(library(factoextra))
> fviz_dend(hc, k = 4 ,cex = 0.5,k_colors = c("#2E9FDF", "#00AFBB", "#E7B800", "#FC4E07"),color_labels_by_k = TRUE, rect = TRUE)
```

![hclust_fivzdend](https://upload-images.jianshu.io/upload_images/14383117-3da83679d54fc8d0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

### 17.å¯¹æ‰€æœ‰æ ·æœ¬çš„è¡¨è¾¾çŸ©é˜µè¿›ï¨ˆPCAåˆ†æå¹¶ä¸”ç»˜å›¾ï¼Œæ·»åŠ è¡¨å‹ä¿¡æ¯

```R
> pca_data <- prcomp(t(exprSet),scale=TRUE)
> pcx <- data.frame(pca_data$x)
> pcr <- cbind(samples=rownames(pcx),grouplist, pcx) 
> ggplot(pcr, aes(PC1, PC2))+geom_point(size=5, aes(color=grouplist)) +
+   geom_text(aes(label=samples),hjust=-0.1, vjust=-0.3)
```

![procmp_ggplot](https://upload-images.jianshu.io/upload_images/14383117-dd9c46b2318879d0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)



### 18. æ ¹æ®è¡¨è¾¾çŸ©é˜µåŠæ ·æœ¬åˆ†ç»„ä¿¡æ¯è¿›ï¨ˆæ‰¹ï¥¾Tæ£€éªŒï¼Œå¾—åˆ°æ£€éªŒç»“æœè¡¨æ ¼

åˆ†ç»„ï¼Œæ±‚på€¼

```R
> gl = as.factor(grouplist)
> group1 = which(grouplist == levels(gl)[1])
> group2 = which(grouplist == levels(gl)[2])
# e = exprSet[rownames(exprSet) %in% mapped_probes,]
> et1 = e[,group1]
> et2 = e[,group2]
> data_t = cbind(et1,et2)
> pvals = apply(e, 1, function(x){
+   t.test(as.numeric(x)~grouplist)$p.value
+ })    ## på€¼
> p.adj = p.adjust(pvals, method = "BH")  ## æ ¡æ­£åçš„på€¼
```

æ±‚log2FC, åšæ‰¹é‡tæ£€éªŒ

```R
> data_mean_c = rowMeans(et1) ## control
> data_mean_t = rowMeans(et2) ## treatment
> log2FC = data_mean_t-data_mean_c
> DEG_t.test = cbind(data_mean_c, data_mean_t, log2FC, pvals, p.adj)
> DEG_t.test=DEG_t.test[order(DEG_t.test[,4]),] ##æ’åº
> DEG_t.test=as.data.frame(DEG_t.test)
> head(DEG_t.test)
#         data_mean_c data_mean_t     log2FC        pvals     p.adj
# 36129_at    7.875615    8.791753  0.9161377 1.629755e-05 0.1867699
# 37676_at    6.622749    7.965007  1.3422581 4.058944e-05 0.2211373
# 33791_at    7.616197    5.786041 -1.8301554 6.965416e-05 0.2211373
# 39967_at    4.456446    2.152471 -2.3039752 8.993339e-05 0.2211373
# 34594_at    5.988866    7.058738  1.0698718 9.648226e-05 0.2211373
# 32198_at    4.157971    3.407405 -0.7505660 2.454557e-04 0.3192169
```



### 19. ä½¿ç”¨limmaåŒ…å¯¹è¡¨è¾¾çŸ©é˜µåŠæ ·æœ¬åˆ†ç»„ä¿¡æ¯è¿›ï¨ˆå·®å¼‚åˆ†æï¼Œå¾—åˆ°å·®å¼‚åˆ†æè¡¨æ ¼

*é‡ç‚¹çœ‹logFCå’ŒPå€¼ï¼Œç”»ç«å±±å›¾(å°±æ˜¯logFCå’Œ-log10(På€¼)çš„æ•£ç‚¹å›¾)ã€‚*

```R
> suppressPackageStartupMessages(library(limma))
> design1=model.matrix(~factor(grouplist))  ## è®¾è®¡çŸ©é˜µ
> colnames(design1)=levels(factor(grouplist))
> rownames(design1)=colnames(exprSet)
> fit1 = lmFit(exprSet,design1)
> fit1=eBayes(fit1)
> options(digits = 3) 
> mtx1 = topTable(fit1,coef=2,adjust='BH',n=Inf) 
> DEG_mtx1 = na.omit(mtx1) ##å»é™¤ç¼ºå¤±å€¼
> head(DEG_mtx1)
#           logFC AveExpr     t  P.Value adj.P.Val    B
# 39400_at  1.028    5.62  5.84 8.34e-06    0.0334 3.23
# 36131_at -0.989    9.95 -5.77 9.67e-06    0.0334 3.12
# 33791_at -1.830    6.95 -5.74 1.05e-05    0.0334 3.05
# 1303_at   1.384    4.46  5.73 1.06e-05    0.0334 3.04
# 36122_at -0.780    7.26 -5.14 4.21e-05    0.1062 1.93
# 36939_at -2.547    6.92 -5.04 5.36e-05    0.1128 1.74
```

ç”»å›¾ï¼š

```R
> DEG=DEG_mtx1
> logFC_cutoff <- with(DEG,mean(abs(logFC)) + 2*sd(abs(logFC)) ) 
> DEG$result = as.factor(ifelse(DEG$P.Value < 0.05 & abs(DEG$logFC) > logFC_cutoff,  ## p.Value<0.05,|logFC|>1
+                               ifelse(DEG$logFC > logFC_cutoff ,'UP','DOWN'),'NOT'))
> title <- paste0('Cutoff for logFC is ',round(logFC_cutoff,3), #roundä¿ï§å°æ•°ä½æ•°
+                     
+                     '\nThe number of up gene is ',nrow(DEG[DEG$result =='UP',]) ,
+                     
+                     '\nThe number of down gene is ',nrow(DEG[DEG$result =='DOWN',])
+ )
> ggplot(data=DEG, aes(x=logFC, y=-log10(P.Value), color=result)) +
+   geom_point(alpha=0.4, size=1.75) +
+   theme_set(theme_set(theme_bw(base_size=20)))+
+   xlab("log2 fold change") + ylab("-log10 p-value") +
+   ggtitle( title ) + theme(plot.title = element_text(size=15,hjust = 0.5))+
+   scale_colour_manual(values = c('blue','black','red'))
```

![ggplot_volcano](https://upload-images.jianshu.io/upload_images/14383117-4a238af8e0b8ffa7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

### 20.å¯¹Tæ£€éªŒç»“æœçš„På€¼å’ŒlimmaåŒ…å·®å¼‚åˆ†æçš„På€¼ç”»æ•£ç‚¹å›¾ï¼Œçœ‹çœ‹å“ªäº›åŸºå› ç›¸å·®å¾ˆå¤§?

```R
> DEG_t.test = DEG_t.test[rownames(DEG_mtx1),]
> colnames(DEG_t.test)
# [1] "data_mean_c" "data_mean_t" "log2FC"      "pvals"      
# [5] "p.adj"      
> colnames(DEG_mtx1)
# [1] "logFC"     "AveExpr"   "t"         "P.Value"   "adj.P.Val"
# [6] "B"        
```

ç”»å›¾ï¼š

```R
> plot(DEG_t.test[,4],DEG_mtx1[,4])
> plot(-log10(DEG_t.test[,4]),-log10(DEG_mtx1[,4]))
```

![ggplot_dot](https://upload-images.jianshu.io/upload_images/14383117-34d067a229028772.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

![ggplot_dot_lg](https://upload-images.jianshu.io/upload_images/14383117-26011711d2bb6ed0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

---
# æœ€åï¼Œå‘å¤§å®¶éš†é‡æ¨èç”Ÿä¿¡æŠ€èƒ½æ ‘çš„ä¸€ç³»åˆ—å¹²è´§ï¼

1.  ç”Ÿä¿¡æŠ€èƒ½æ ‘å…¨çƒå…¬ç›Šå·¡è®²ï¼š[https://mp.weixin.qq.com/s/E9ykuIbc-2Ja9HOY0bn_6g](https://links.jianshu.com/go?to=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FE9ykuIbc-2Ja9HOY0bn_6g)
2.  Bç«™å…¬ç›Š74å°æ—¶ç”Ÿä¿¡å·¥ç¨‹å¸ˆæ•™å­¦è§†é¢‘åˆè¾‘ï¼š[https://mp.weixin.qq.com/s/IyFK7l_WBAiUgqQi8O7Hxw](https://links.jianshu.com/go?to=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FIyFK7l_WBAiUgqQi8O7Hxw)
3.  æ‹›å­¦å¾’ï¼š[https://mp.weixin.qq.com/s/KgbilzXnFjbKKunuw7NVfw](https://links.jianshu.com/go?to=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FKgbilzXnFjbKKunuw7NVfw)
